<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Docker Swarm 集群 | 在路上</title>
  <meta name="author" content="Sven">
  
  <meta name="description" content="让大家读得懂的知识才是真知识">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Docker Swarm 集群"/>
  <meta property="og:site_name" content="在路上"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="在路上" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">在路上</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">关于我</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2019-04-16T09:38:00.000Z"><a href="/2019/04/16/docker-swarm-mode/">2019-04-16</a></time>
      
      
  
    <h1 class="title">Docker Swarm 集群</h1>
  

    </header>
    <div class="entry">
      
        
			<div id="toc" class="toc-article">
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-nbsp-nbsp-环境"><span class="toc-text">1   环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-nbsp-nbsp-集群初始化"><span class="toc-text">2   集群初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-nbsp-nbsp-创建服务"><span class="toc-text">3   创建服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-nbsp-nbsp-Scale-规模"><span class="toc-text">4   Scale 规模</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-nbsp-nbsp-滚动升级"><span class="toc-text">5   滚动升级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-nbsp-nbsp-节点管理"><span class="toc-text">6   节点管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-nbsp-nbsp-新增节点"><span class="toc-text">6.1   新增节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-nbsp-nbsp-更新节点"><span class="toc-text">6.2   更新节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-nbsp-nbsp-删除节点"><span class="toc-text">6.3   删除节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-nbsp-nbsp-删除服务"><span class="toc-text">7   删除服务</span></a></li></ol>
			</div>
		
        <p>概括来说，Swarm 有两个核心组件：</p>
<ul>
<li>企业级的 Docker 安全集群</li>
<li>微服务应用编排引擎<a id="more"></a>
</li>
</ul>
<h2 id="1-nbsp-nbsp-环境"><a href="#1-nbsp-nbsp-环境" class="headerlink" title="1 &nbsp;&nbsp;环境"></a>1 &nbsp;&nbsp;环境</h2><p>Swarm 对主机（节点）的要求并不高，我在4台 f1-micro（1 个 vCPU，0.6 GB 内存）+ 10G磁盘上操作，开启三个小型的服务共40个副本（采取逐步调整 scale，每个副本 13M 左右，平均一个节点10个副本），副本太多容易导致 Leader 节点编排的时候 Docker 服务宕掉，所以 Leader 性能要好一点。总之对学习来说并不存在环境障碍。</p>
<ul>
<li><p>用四台机器进行部署：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">姓名        地区                        内部 IP</span><br><span class="line">binke01    asia-northeast1-a           10.146.0.2 (nic0)   </span><br><span class="line">binke01-1  asia-northeast1-a           10.146.0.3 (nic0)   </span><br><span class="line">binke01-2  asia-northeast1-a           10.146.0.4 (nic0)   </span><br><span class="line">binke01-3  asia-northeast1-a           10.146.0.5 (nic0)</span><br></pre></td></tr></table></figure>
</li>
<li><p>开放端口，一般云服务器内网不需要此操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=2377/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=7946/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=7946/udp</span><br><span class="line">firewall-cmd --permanent --add-port=4789/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备应用代码，我是用 Go 写的一个小应用，一共两个版本，只是把“this is version 1”中的改为2即可，build 完后必须推到 hub 库，创建服务的时候节点在本地查找镜像，没找到会去拉取；代码读取容器的 HOSTNAME（容器的 HOSTNAME 其实就是容器的 ID），可以检验基于 Ingress 的容器负载均衡：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;main.go</span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;net/http&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func IndexHandler(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">    host := os.Getenv(&quot;HOSTNAME&quot;)</span><br><span class="line">    fmt.Fprintln(w, &quot;hello world &quot;+ host +&quot;, this is version 1.&quot; )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main()  &#123;</span><br><span class="line">    http.Handle(&quot;/pattern&quot;, http.HandlerFunc(IndexHandler))</span><br><span class="line">    http.ListenAndServe(&quot;:80&quot;, nil)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 Dockerfile，采用多阶段构建方式，使得镜像只有 12.9MB</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;Dockerfile</span><br><span class="line">FROM golang:1.12.4-alpine3.9  AS front</span><br><span class="line">COPY main.go /go/src/github.com/wpxun/onlygo/</span><br><span class="line">RUN set -xe &amp;&amp; go install github.com/wpxun/onlygo</span><br><span class="line"></span><br><span class="line">FROM alpine:3.9</span><br><span class="line">ENV GOM_VERSION   1904.1</span><br><span class="line">COPY --from=front /go/bin /go/bin/</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [&quot;/go/bin/onlygo&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-nbsp-nbsp-集群初始化"><a href="#2-nbsp-nbsp-集群初始化" class="headerlink" title="2 &nbsp;&nbsp;集群初始化"></a>2 &nbsp;&nbsp;集群初始化</h2><p>只能在管理节点上初始化 Swarm 集群。我把 binke01-1 节点初始化：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker swarm init</span><br><span class="line">Swarm initialized: current node (qr7i763tagufpcyn4qf37b5fs) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-33x2n6mrudf0x4s4j3zque3lec9c2dq5jeiaj17b7yujuaklns-ayc7mxqui49frdgb8hadcmmyf 10.146.0.3:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure></p>
<p>按上面的提示把其它节点 join 进来，查看节点列表：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">0kjqucshibpm35zhq7kizldp0     binke01             Ready               Active                                  18.09.3</span><br><span class="line">qr7i763tagufpcyn4qf37b5fs *   binke01-1           Ready               Active              Leader              18.09.5</span><br><span class="line">186b6a4dpvy8alzdfuf3jtrv4     binke01-2           Ready               Active                                  18.09.5</span><br><span class="line">ogvwkwq0zxw3s05shey2ruzqa     binke01-3           Ready               Active              Reachable           18.09.5</span><br></pre></td></tr></table></figure></p>
<p>其中 * 表示当前命令所在的节点，工作节点不能查看或者管理集群状态（node、service 等子命令不能用）。<br>Docker Swarm 推荐奇数个管理节点（1，3，5，不要大于7个）。</p>
<p>创建一个覆盖网络（即驱动类型：overlay）<br>bridge 是 single-host network，其 SCOPE 只能是 local；而 overlay 是 multi-host network，其 SCOPE 则是 swarm。且只能在 manager node 创建，此时只有当前的 Swarm 管理节点可见，其它节点如果有容器接入该网络后也是可见的。<br>如果是 docker-compose 创建的，其名称是“目录名_网络名”。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;docker network create -d overlay onlygo-net</span><br><span class="line">fe1wzq8dljvcqzd8o5vhw7bma</span><br><span class="line"></span><br><span class="line">&gt; docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">079de4d69078        bridge              bridge              local</span><br><span class="line">41c3503514c2        docker_gwbridge     bridge              local</span><br><span class="line">e6f7a28b3b05        host                host                local</span><br><span class="line">njzh016c5qrl        ingress             overlay             swarm</span><br><span class="line">cf1660673a83        none                null                local</span><br><span class="line">fe1wzq8dljvc        onlygo-net          overlay             swarm</span><br></pre></td></tr></table></figure></p>
<h2 id="3-nbsp-nbsp-创建服务"><a href="#3-nbsp-nbsp-创建服务" class="headerlink" title="3 &nbsp;&nbsp;创建服务"></a>3 &nbsp;&nbsp;创建服务</h2><p>无论哪种模式，即使主节点（Leader）挂掉，其它没挂掉的节点还是可以访问。而挂掉的节点其 IP 一定不能访问。</p>
<ol>
<li><p>入站模式（Ingress Mode），也是默认的模式，是在 Swarm 中的所有节点开放端口：</p>
<ul>
<li>即使节点上没有服务的副本，通过 IP 也可以访问，所有的节点都配置有映射，因此会将请求转发给运行有服务副本的节点，相当有了负载的能力，即基于 Ingress 的容器负载均衡；当然如果某个节点 Down 掉，则不可能再访问那个节点的 IP。</li>
<li>一个节点可以有多个副本，如下的 binke01-2 节点有两个副本</li>
<li>通过端口显示（为空或 80/tcp）就可以看出是服务提供统一端口，单引擎和 Swarm 端口冲突时不管谁先启动，以 Swarm 优先，即如果宿主机端口已经占用，docker 会把它分配回给 Swarm，从这一点看如果已经是 Swarm 就不建议同时作为单引擎使用了，当然如果端口不冲突那是可以共用的。<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker service create --name onlygo-svc -p 80:80 --replicas 5 --network onlygo-net wpxun/onlygo:v1</span><br><span class="line"></span><br><span class="line"># PORTS 看出服务提供端口</span><br><span class="line">&gt; docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">zai8apyhcv0c        onlygo-svc          replicated          5/5                 wpxun/onlygo:v1     *:80-&gt;80/tcp</span><br><span class="line"></span><br><span class="line"># PORTS 看出节点并没有提供端口</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">asda8ds4ae70        onlygo-svc.1        wpxun/onlygo:v1     binke01-2           Running             Running 31 seconds ago</span><br><span class="line">0dpg2041gjhv        onlygo-svc.2        wpxun/onlygo:v1     binke01-2           Running             Running 31 seconds ago</span><br><span class="line">h0a302tciz4d        onlygo-svc.3        wpxun/onlygo:v1     binke01-3           Running             Running 32 seconds ago</span><br><span class="line">c4zs50l7ji3m        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 35 seconds ago</span><br><span class="line">lm5rvn4oc2h6        onlygo-svc.5        wpxun/onlygo:v1     binke01             Running             Running 32 seconds ago</span><br><span class="line"></span><br><span class="line">&gt; docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS               NAMES</span><br><span class="line">6389302152c1        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    About a minute ago   Up About a minute   80/tcp              onlygo-svc.4.c4zs50l7ji3mw4ate9iz7m6bv</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>主机模式（Host Mode），即仅在运行有容器副本的节点上开放端口：</p>
<ul>
<li>节点上如果没有服务的副本，就不能通过 IP 访问，节点不配置映射，相当于没有负载</li>
<li>一个节点最多只能有一个副本，如果副本多于节点，会提示 no suitable node (host-mode port already in use on 4 nodes)</li>
<li>通过端口显示（*:80-&gt;80/tcp 和 0.0.0.0:80-&gt;80/tcp）就可以看出是各节点各自提供端口；另外还要防止端口冲突：Bind for 0.0.0.0:80 failed: port is already allocated<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker service create --name onlygo-svc --publish published=80,target=80,mode=host --replicas 5 --network onlygo-net wpxun/onlygo:v1</span><br><span class="line"></span><br><span class="line"># PORTS 看出节点提供端口</span><br><span class="line">&gt; docker service ps --no-trunc onlygo-svc</span><br><span class="line">ID                          NAME                IMAGE                                                                                     NODE                DESIRED STATE       CURRENT STATE            ERROR                                                           PORTS</span><br><span class="line">u7a6xsh8si0uz9917j3i3gp3d   onlygo-svc.1        wpxun/onlygo:v1@sha256:b98f1f36fe80f113f4e23932fc5a0314ced0ef87f5e1b33d0528a05acbd2c2f5   binke01-2           Running             Running 8 minutes ago                                                                    *:80-&gt;80/tcp</span><br><span class="line">f51qf2f3cl5pt2jjda1323pux   onlygo-svc.2        wpxun/onlygo:v1@sha256:b98f1f36fe80f113f4e23932fc5a0314ced0ef87f5e1b33d0528a05acbd2c2f5   binke01-3           Running             Running 8 minutes ago                                                                    *:80-&gt;80/tcp</span><br><span class="line">n9rgob84kpa4d2b7fgswnt1ib   onlygo-svc.3        wpxun/onlygo:v1@sha256:b98f1f36fe80f113f4e23932fc5a0314ced0ef87f5e1b33d0528a05acbd2c2f5   binke01-1           Running             Running 8 minutes ago                                                                    *:80-&gt;80/tcp</span><br><span class="line">n3wjdse90bjp47cauozew8rny   onlygo-svc.4        wpxun/onlygo:v1@sha256:b98f1f36fe80f113f4e23932fc5a0314ced0ef87f5e1b33d0528a05acbd2c2f5   binke01             Running             Running 53 seconds ago                                                                   *:80-&gt;80/tcp</span><br><span class="line">m3k4wlocswfila6evuvrocydv   onlygo-svc.5        wpxun/onlygo:v1@sha256:b98f1f36fe80f113f4e23932fc5a0314ced0ef87f5e1b33d0528a05acbd2c2f5                       Running             Pending 55 seconds ago   &quot;no suitable node (host-mode port already in use on 4 nodes)&quot;</span><br><span class="line"></span><br><span class="line">[feixin10@binke01-3 ~]$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                NAMES</span><br><span class="line">51b3c95d4772        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    30 minutes ago      Up 30 minutes       0.0.0.0:80-&gt;80/tcp   onlygo-svc.2.f51qf2f3cl5pt2jjda1323pux</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>另外要注意几点：<br>（1）通过 <code>docker service ls</code> 列表的 PORTS 表示服务的端口，而通过 <code>docker service ps onlygo-svc</code> 列表的 PORTS 表示节点的端口。<br>（2）拉取的镜像 tag 为 none(如下图正常 create 时 tag 为 v1 和 v2)，不要进行修改，否则运行的容器会退出。当然可以退出副本看管理节点自动控制能力，docker service ps 列表的 ERROR 行也可以看出哪些副本状态异常。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker images -a</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">wpxun/onlygo        &lt;none&gt;              c36b4eaf86ea        6 hours ago         12.9MB</span><br><span class="line">wpxun/onlygo        &lt;none&gt;              bb89b247fa08        6 hours ago         12.9MB</span><br></pre></td></tr></table></figure></p>
<h2 id="4-nbsp-nbsp-Scale-规模"><a href="#4-nbsp-nbsp-Scale-规模" class="headerlink" title="4 &nbsp;&nbsp;Scale 规模"></a>4 &nbsp;&nbsp;Scale 规模</h2><p>缩放 scale 和 create 是很像的，如果有副本异常会持续编排，可能通过 ctrl+c 中断（不会影响正常运行的副本）。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker service scale onlygo-svc=3</span><br><span class="line">onlygo-svc scaled to 3</span><br><span class="line">overall progress: 3 out of 3 tasks</span><br><span class="line">1/3: running   [==================================================&gt;]</span><br><span class="line">2/3: running   [==================================================&gt;]</span><br><span class="line">3/3: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure></p>
<h2 id="5-nbsp-nbsp-滚动升级"><a href="#5-nbsp-nbsp-滚动升级" class="headerlink" title="5 &nbsp;&nbsp;滚动升级"></a>5 &nbsp;&nbsp;滚动升级</h2><p><code>docker service update --image wpxun/onlygo:v2 --update-parallelism 2 --update-delay 80s onlygo-svc</code></p>
<ul>
<li>image 要升级为的镜像</li>
<li>update-parallelism 每次使用新镜像更新的副本数</li>
<li>update-delay 每次更新的延迟时间</li>
</ul>
<p>下面是运行结果，初始是 5 个副本，每次更新 2 个副本，经过三轮更新，每轮 80s 延迟。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 初始 5 个副本</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS</span><br><span class="line">vrenb115qwe9        onlygo-svc.1        wpxun/onlygo:v1     binke01             Running             Running 9 minutes ago</span><br><span class="line">w4sz99i5xfgm        onlygo-svc.2        wpxun/onlygo:v1     binke01-2           Running             Running 9 minutes ago</span><br><span class="line">fe5bh6j2o6jq        onlygo-svc.3        wpxun/onlygo:v1     binke01-3           Running             Running 9 minutes ago</span><br><span class="line">vyv2hj1q8tdn        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 9 minutes ago</span><br><span class="line">usrztf48878j        onlygo-svc.5        wpxun/onlygo:v1     binke01             Running             Running 9 minutes ago</span><br><span class="line"></span><br><span class="line"># 第一轮更新</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                    ERROR               PORTS</span><br><span class="line">vrenb115qwe9        onlygo-svc.1        wpxun/onlygo:v1     binke01             Running             Running 10 minutes ago</span><br><span class="line">obtas0qo4lq6        onlygo-svc.2        wpxun/onlygo:v2     binke01-3           Running             Running less than a second ago</span><br><span class="line">w4sz99i5xfgm         \_ onlygo-svc.2    wpxun/onlygo:v1     binke01-2           Shutdown            Shutdown 5 seconds ago</span><br><span class="line">xl3fldhit8s4        onlygo-svc.3        wpxun/onlygo:v2     binke01-2           Running             Running 4 seconds ago</span><br><span class="line">fe5bh6j2o6jq         \_ onlygo-svc.3    wpxun/onlygo:v1     binke01-3           Shutdown            Shutdown 6 seconds ago</span><br><span class="line">vyv2hj1q8tdn        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 10 minutes ago</span><br><span class="line">usrztf48878j        onlygo-svc.5        wpxun/onlygo:v1     binke01             Running             Running 10 minutes ago</span><br><span class="line"></span><br><span class="line"># 等待 80s</span><br><span class="line"># 第二轮更新</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                 ERROR               PORTS</span><br><span class="line">4hrqsqc59stn        onlygo-svc.1        wpxun/onlygo:v2     binke01             Running             Running 28 seconds ago</span><br><span class="line">vrenb115qwe9         \_ onlygo-svc.1    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 29 seconds ago</span><br><span class="line">obtas0qo4lq6        onlygo-svc.2        wpxun/onlygo:v2     binke01-3           Running             Running about a minute ago</span><br><span class="line">w4sz99i5xfgm         \_ onlygo-svc.2    wpxun/onlygo:v1     binke01-2           Shutdown            Shutdown about a minute ago</span><br><span class="line">xl3fldhit8s4        onlygo-svc.3        wpxun/onlygo:v2     binke01-2           Running             Running about a minute ago</span><br><span class="line">fe5bh6j2o6jq         \_ onlygo-svc.3    wpxun/onlygo:v1     binke01-3           Shutdown            Shutdown about a minute ago</span><br><span class="line">vyv2hj1q8tdn        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 12 minutes ago</span><br><span class="line">7jcq34xnxhpw        onlygo-svc.5        wpxun/onlygo:v2     binke01-3           Running             Running 32 seconds ago</span><br><span class="line">usrztf48878j         \_ onlygo-svc.5    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 33 seconds ago</span><br><span class="line"></span><br><span class="line"># 等待 80s</span><br><span class="line"># 第三轮更新</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                 ERROR               PORTS</span><br><span class="line">4hrqsqc59stn        onlygo-svc.1        wpxun/onlygo:v2     binke01             Running             Running about a minute ago</span><br><span class="line">vrenb115qwe9         \_ onlygo-svc.1    wpxun/onlygo:v1     binke01             Shutdown            Shutdown about a minute ago</span><br><span class="line">obtas0qo4lq6        onlygo-svc.2        wpxun/onlygo:v2     binke01-3           Running             Running 2 minutes ago</span><br><span class="line">w4sz99i5xfgm         \_ onlygo-svc.2    wpxun/onlygo:v1     binke01-2           Shutdown            Shutdown 3 minutes ago</span><br><span class="line">xl3fldhit8s4        onlygo-svc.3        wpxun/onlygo:v2     binke01-2           Running             Running 3 minutes ago</span><br><span class="line">fe5bh6j2o6jq         \_ onlygo-svc.3    wpxun/onlygo:v1     binke01-3           Shutdown            Shutdown 3 minutes ago</span><br><span class="line">tmnwlqvydpgn        onlygo-svc.4        wpxun/onlygo:v2     binke01-1           Running             Running 11 seconds ago</span><br><span class="line">vyv2hj1q8tdn         \_ onlygo-svc.4    wpxun/onlygo:v1     binke01-1           Shutdown            Shutdown 12 seconds ago</span><br><span class="line">7jcq34xnxhpw        onlygo-svc.5        wpxun/onlygo:v2     binke01-3           Running             Running about a minute ago</span><br><span class="line">usrztf48878j         \_ onlygo-svc.5    wpxun/onlygo:v1     binke01             Shutdown            Shutdown about a minute ago</span><br><span class="line"></span><br><span class="line"># 查看每个节点运行的容器，比如在 binke01-1 上查看</span><br><span class="line">&gt; docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">107b41631240        wpxun/onlygo:v2     &quot;/go/bin/onlygo&quot;    8 minutes ago       Up 8 minutes               80/tcp              onlygo-svc.4.tmnwlqvydpgng67an6hliqibx</span><br><span class="line">a5faabc04466        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    22 minutes ago      Exited (2) 8 minutes ago                       onlygo-svc.4.vyv2hj1q8tdnedue98c2725z3</span><br></pre></td></tr></table></figure></p>
<p>可以注意到，Swarm 在升级中会均衡的将副本分配给 Swarm 中的所有节点。</p>
<p>查看 inspect 可以看到，更新的配置已经成为服务定义的一部分，之后的更新将会自动使用这些设置，直到使用参数覆盖它们。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker service inspect --pretty onlygo-svc</span><br><span class="line"></span><br><span class="line">ID:     p9p5hfije6krnjtrusz3ut1st</span><br><span class="line">Name:       onlygo-svc</span><br><span class="line">Service Mode:   Replicated</span><br><span class="line"> Replicas:  5</span><br><span class="line">UpdateStatus:</span><br><span class="line"> State:     completed</span><br><span class="line"> Started:   19 minutes ago</span><br><span class="line"> Completed: 14 minutes ago</span><br><span class="line"> Message:   update completed</span><br><span class="line">Placement:</span><br><span class="line">UpdateConfig:</span><br><span class="line"> Parallelism:   2</span><br><span class="line"> Delay:     1m20s</span><br><span class="line"> On failure:    pause</span><br><span class="line"> Monitoring Period: 5s</span><br><span class="line"> Max failure ratio: 0</span><br><span class="line"> Update order:      stop-first</span><br><span class="line">RollbackConfig:</span><br><span class="line"> Parallelism:   1</span><br><span class="line"> On failure:    pause</span><br><span class="line"> Monitoring Period: 5s</span><br><span class="line"> Max failure ratio: 0</span><br><span class="line"> Rollback order:    stop-first</span><br><span class="line">ContainerSpec:</span><br><span class="line"> Image:     wpxun/onlygo:v2@sha256:5a4e11c60f0ff8956b7ae972e0588753c27fc0376025e1fc02582af21d84dab7</span><br><span class="line"> Init:      false</span><br><span class="line">Resources:</span><br><span class="line">Endpoint Mode:  vip</span><br><span class="line">Ports:</span><br><span class="line"> PublishedPort = 80</span><br><span class="line">  Protocol = tcp</span><br><span class="line">  TargetPort = 80</span><br><span class="line">  PublishMode = ingress</span><br></pre></td></tr></table></figure></p>
<p>再次“升级”回 v1 版本 <code>docker service update --image wpxun/onlygo:v1 onlygo-svc</code>：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 第三轮升级等待中</span><br><span class="line">&gt; docker service update --image wpxun/onlygo:v1 onlygo-svc</span><br><span class="line">onlygo-svc</span><br><span class="line">overall progress: 4 out of 5 tasks</span><br><span class="line">1/5: running   [==================================================&gt;]</span><br><span class="line">2/5: running   [==================================================&gt;]</span><br><span class="line">3/5:</span><br><span class="line">4/5: running   [==================================================&gt;]</span><br><span class="line">5/5: running   [==================================================&gt;]</span><br><span class="line"></span><br><span class="line"># 升级完成查看副本列表</span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                 ERROR               PORTS</span><br><span class="line">xsry6d3b57qy        onlygo-svc.1        wpxun/onlygo:v1     binke01             Running             Running 2 minutes ago</span><br><span class="line">4hrqsqc59stn         \_ onlygo-svc.1    wpxun/onlygo:v2     binke01             Shutdown            Shutdown 3 minutes ago</span><br><span class="line">vrenb115qwe9         \_ onlygo-svc.1    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 24 minutes ago</span><br><span class="line">39g1ghfjc2up        onlygo-svc.2        wpxun/onlygo:v1     binke01-3           Running             Running about a minute ago</span><br><span class="line">obtas0qo4lq6         \_ onlygo-svc.2    wpxun/onlygo:v2     binke01-3           Shutdown            Shutdown about a minute ago</span><br><span class="line">w4sz99i5xfgm         \_ onlygo-svc.2    wpxun/onlygo:v1     binke01-2           Shutdown            Shutdown 26 minutes ago</span><br><span class="line">jsbd3x38qouo        onlygo-svc.3        wpxun/onlygo:v1     binke01-2           Running             Running about a minute ago</span><br><span class="line">xl3fldhit8s4         \_ onlygo-svc.3    wpxun/onlygo:v2     binke01-2           Shutdown            Shutdown about a minute ago</span><br><span class="line">fe5bh6j2o6jq         \_ onlygo-svc.3    wpxun/onlygo:v1     binke01-3           Shutdown            Shutdown 26 minutes ago</span><br><span class="line">ig89pa0ylmrf        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 7 seconds ago</span><br><span class="line">tmnwlqvydpgn         \_ onlygo-svc.4    wpxun/onlygo:v2     binke01-1           Shutdown            Shutdown 9 seconds ago</span><br><span class="line">vyv2hj1q8tdn         \_ onlygo-svc.4    wpxun/onlygo:v1     binke01-1           Shutdown            Shutdown 23 minutes ago</span><br><span class="line">ud4kn771erry        onlygo-svc.5        wpxun/onlygo:v1     binke01             Running             Running 2 minutes ago</span><br><span class="line">7jcq34xnxhpw         \_ onlygo-svc.5    wpxun/onlygo:v2     binke01-3           Shutdown            Shutdown 3 minutes ago</span><br><span class="line">usrztf48878j         \_ onlygo-svc.5    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 24 minutes ago</span><br><span class="line"></span><br><span class="line"># 在某个节点上查看运行的容器，对应上面该节点上的副本的状态</span><br><span class="line">[feixin10@binke01 ~]$ docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES</span><br><span class="line">619e375ca3f9        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    5 minutes ago       Up 5 minutes                80/tcp              onlygo-svc.5.ud4kn771erryzg2d0cansm3md</span><br><span class="line">26ac4c19a78f        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    5 minutes ago       Up 5 minutes                80/tcp              onlygo-svc.1.xsry6d3b57qy1bpc2x8ptbxyd</span><br><span class="line">0f54cadb8f00        wpxun/onlygo:v2     &quot;/go/bin/onlygo&quot;    26 minutes ago      Exited (2) 5 minutes ago                        onlygo-svc.1.4hrqsqc59stnioxgmo94h6gsa</span><br><span class="line">75b3967ee0c9        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    38 minutes ago      Exited (2) 26 minutes ago                       onlygo-svc.5.usrztf48878jn3490qeujwjc6</span><br><span class="line">13ccf9d7fbaa        wpxun/onlygo:v1     &quot;/go/bin/onlygo&quot;    38 minutes ago      Exited (2) 26 minutes ago                       onlygo-svc.1.vrenb115qwe9qg488megfnq1j</span><br></pre></td></tr></table></figure></p>
<h2 id="6-nbsp-nbsp-节点管理"><a href="#6-nbsp-nbsp-节点管理" class="headerlink" title="6 &nbsp;&nbsp;节点管理"></a>6 &nbsp;&nbsp;节点管理</h2><p>节点的选择可以用 ID 或 HOSTNAME。</p>
<h3 id="6-1-nbsp-nbsp-新增节点"><a href="#6-1-nbsp-nbsp-新增节点" class="headerlink" title="6.1 &nbsp;&nbsp;新增节点"></a>6.1 &nbsp;&nbsp;新增节点</h3><p><code>docker swarm join --token</code><br>下面新增节点 binke01-4，ip:10.146.0.6，然后修改 scale = 9，然后查看编排结果：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker swarm join --token SWMTKN-1-33x2n6mrudf0x4s4j3zque3lec9c2dq5jeiaj17b7yujuaklns-ayc7mxqui49frdgb8hadcmmyf 10.146.0.3:2377</span><br><span class="line">&gt; docker service scale onlygo-svc=9</span><br><span class="line"></span><br><span class="line">&gt; docker service ps onlygo-svc</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE             ERROR               PORTS</span><br><span class="line">xsry6d3b57qy        onlygo-svc.1        wpxun/onlygo:v1     binke01             Running             Running 18 minutes ago</span><br><span class="line">4hrqsqc59stn         \_ onlygo-svc.1    wpxun/onlygo:v2     binke01             Shutdown            Shutdown 18 minutes ago</span><br><span class="line">vrenb115qwe9         \_ onlygo-svc.1    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 40 minutes ago</span><br><span class="line">39g1ghfjc2up        onlygo-svc.2        wpxun/onlygo:v1     binke01-3           Running             Running 17 minutes ago</span><br><span class="line">obtas0qo4lq6         \_ onlygo-svc.2    wpxun/onlygo:v2     binke01-3           Shutdown            Shutdown 17 minutes ago</span><br><span class="line">w4sz99i5xfgm         \_ onlygo-svc.2    wpxun/onlygo:v1     binke01-2           Shutdown            Shutdown 41 minutes ago</span><br><span class="line">jsbd3x38qouo        onlygo-svc.3        wpxun/onlygo:v1     binke01-2           Running             Running 17 minutes ago</span><br><span class="line">xl3fldhit8s4         \_ onlygo-svc.3    wpxun/onlygo:v2     binke01-2           Shutdown            Shutdown 17 minutes ago</span><br><span class="line">fe5bh6j2o6jq         \_ onlygo-svc.3    wpxun/onlygo:v1     binke01-3           Shutdown            Shutdown 41 minutes ago</span><br><span class="line">ig89pa0ylmrf        onlygo-svc.4        wpxun/onlygo:v1     binke01-1           Running             Running 15 minutes ago</span><br><span class="line">tmnwlqvydpgn         \_ onlygo-svc.4    wpxun/onlygo:v2     binke01-1           Shutdown            Shutdown 15 minutes ago</span><br><span class="line">vyv2hj1q8tdn         \_ onlygo-svc.4    wpxun/onlygo:v1     binke01-1           Shutdown            Shutdown 38 minutes ago</span><br><span class="line">ud4kn771erry        onlygo-svc.5        wpxun/onlygo:v1     binke01             Running             Running 18 minutes ago</span><br><span class="line">7jcq34xnxhpw         \_ onlygo-svc.5    wpxun/onlygo:v2     binke01-3           Shutdown            Shutdown 18 minutes ago</span><br><span class="line">usrztf48878j         \_ onlygo-svc.5    wpxun/onlygo:v1     binke01             Shutdown            Shutdown 40 minutes ago</span><br><span class="line">lxjhy78nsn45        onlygo-svc.6        wpxun/onlygo:v1     binke01-4           Running             Running 10 seconds ago</span><br><span class="line">nzc6wenlsl8o        onlygo-svc.7        wpxun/onlygo:v1     binke01-4           Running             Running 10 seconds ago</span><br><span class="line">fz51eign4ms1        onlygo-svc.8        wpxun/onlygo:v1     binke01-3           Running             Running 15 seconds ago</span><br><span class="line">ma78euhri5p6        onlygo-svc.9        wpxun/onlygo:v1     binke01-1           Running             Running 15 seconds ago</span><br></pre></td></tr></table></figure></p>
<h3 id="6-2-nbsp-nbsp-更新节点"><a href="#6-2-nbsp-nbsp-更新节点" class="headerlink" title="6.2 &nbsp;&nbsp;更新节点"></a>6.2 &nbsp;&nbsp;更新节点</h3><ol>
<li><p><code>docker node update --role worker binke01-3</code> 把节点转成工作节点，转换后至少还存在一个管理节点就可以，比如有两个管理节点，把 leader 转成工作节点，则另一个管理节点会转成 leader；–role 有两个选项 worker|manager</p>
</li>
<li><p><code>docker node update --availability drain binke01-4</code></p>
<ul>
<li>availability string(“active”|”pause”|”drain”) 其中 drain 即是排空节点，把节点上的副本移到其它节点，同时阻止在该节点上分配新的副本；</li>
</ul>
</li>
</ol>
<h3 id="6-3-nbsp-nbsp-删除节点"><a href="#6-3-nbsp-nbsp-删除节点" class="headerlink" title="6.3 &nbsp;&nbsp;删除节点"></a>6.3 &nbsp;&nbsp;删除节点</h3><ol>
<li><p>离开 Swarm 群，可以在任意节点上操作，使其连通状态为 Down；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[feixin10@binke01-4 ~]$ docker swarm leave</span><br><span class="line">Node left the swarm.</span><br></pre></td></tr></table></figure>
<p>查看节点列表，status 表示节点连通状态有 Ready|Down；availability 表示可编排状态，有 active|pause|drain 三种状态。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">0kjqucshibpm35zhq7kizldp0     binke01             Ready               Active                                  18.09.3</span><br><span class="line">qr7i763tagufpcyn4qf37b5fs *   binke01-1           Ready               Active              Reachable           18.09.5</span><br><span class="line">186b6a4dpvy8alzdfuf3jtrv4     binke01-2           Ready               Active                                  18.09.5</span><br><span class="line">ogvwkwq0zxw3s05shey2ruzqa     binke01-3           Ready               Active              Leader              18.09.5</span><br><span class="line">zadyw6n9o8h14x0flsjmrkoyl     binke01-4           Down                Drain                                   18.09.5</span><br></pre></td></tr></table></figure>
<p>除此之外，节点的 Docker 服务未开启时也是 Down 状态。</p>
</li>
<li><p>删除节点，只有 Down 状态下才可能删除(不在乎 availability 的状态)，另外还有强制删除但不建议使用；<br><code>docker node rm binke01-4</code></p>
</li>
</ol>
<h2 id="7-nbsp-nbsp-删除服务"><a href="#7-nbsp-nbsp-删除服务" class="headerlink" title="7 &nbsp;&nbsp;删除服务"></a>7 &nbsp;&nbsp;删除服务</h2><p><code>docker service rm onlygo-svc</code>，没有任何警告，直接删除服务和所有的副本，但不会删除拉取过的镜像。</p>
<p><br><br><br></p>
<p> <strong>参考文献</strong><br>[1] Nigel Poulton. 深入浅出 Dokcer. 版次：2019年4月第1版<br>[2] Getting started with swarm mode. <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/" target="_blank" rel="noopener">https://docs.docker.com/engine/swarm/swarm-tutorial/</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Docker/">Docker</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Docker/">Docker</a>, <a href="/tags/容器化/">容器化</a>, <a href="/tags/部署/">部署</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.jemper.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/DevOps/">DevOps</a><small>4</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>4</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>6</small></li>
  
    <li><a href="/categories/HTTPS/">HTTPS</a><small>5</small></li>
  
    <li><a href="/categories/Kubernetes/">Kubernetes</a><small>3</small></li>
  
    <li><a href="/categories/日记/">日记</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Compose/" style="font-size: 10px;">Compose</a> <a href="/tags/DevOps/" style="font-size: 16.67px;">DevOps</a> <a href="/tags/Docker/" style="font-size: 20px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/Golang/" style="font-size: 20px;">Golang</a> <a href="/tags/Go包/" style="font-size: 13.33px;">Go包</a> <a href="/tags/HTTP/" style="font-size: 16.67px;">HTTP</a> <a href="/tags/HTTP2/" style="font-size: 13.33px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 13.33px;">HTTPS</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 16.67px;">Kubernetes</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Socket/" style="font-size: 13.33px;">Socket</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/TLS/" style="font-size: 16.67px;">TLS</a> <a href="/tags/io/" style="font-size: 13.33px;">io</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/协议/" style="font-size: 16.67px;">协议</a> <a href="/tags/容器化/" style="font-size: 16.67px;">容器化</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/工具/" style="font-size: 16.67px;">工具</a> <a href="/tags/并发/" style="font-size: 13.33px;">并发</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/架构/" style="font-size: 13.33px;">架构</a> <a href="/tags/生活/" style="font-size: 13.33px;">生活</a> <a href="/tags/编程/" style="font-size: 10px;">编程</a> <a href="/tags/网络/" style="font-size: 13.33px;">网络</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a> <a href="/tags/部署/" style="font-size: 16.67px;">部署</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2019 Sven
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wpxun';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
