<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Dockerfile 创建镜像 | 在路上</title>
  <meta name="author" content="Sven">
  
  <meta name="description" content="让大家读得懂的知识才是真知识">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Dockerfile 创建镜像"/>
  <meta property="og:site_name" content="在路上"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="在路上" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">在路上</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">关于我</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2019-04-15T09:00:14.000Z"><a href="/2019/04/15/docker-dockerfile/">2019-04-15</a></time>
      
      
  
    <h1 class="title">Dockerfile 创建镜像</h1>
  

    </header>
    <div class="entry">
      
        
			<div id="toc" class="toc-article">
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-nbsp-nbsp-实例"><span class="toc-text">2   实例</span></a></li></ol>
			</div>
		
        <p>Dockerfile 用来快速创建自定义镜像，具有众多的指令。一般分为四部分：基础镜像信息、维护者信息、镜像操作指令和容器启动时执行指令。<br><a id="more"></a></p>
<p>镜像常用 Dockerfile 指令文件创建，创建命令：<code>docker build -t NAME[:TAG] Dockerfile-Path</code>。它几乎无需指定参数，但还是简单说明几个：</p>
<ul>
<li>–rm 成功 build 后删除中间运行的容器，默认为true。还有一个 –force-rm，无论成不成功都删除，不建议使用，因为失败了还可以通过容器调试。<br>注意这里要区别于中间镜像，在 build 中 <code>---&gt; cdf98d1859c1</code> 表示依赖的镜像或者中间镜像，<code>---&gt; Running in 1d2485ce71e9</code> 表示中间容器。</li>
<li>–no-cache 不走缓存</li>
</ul>
<h2 id="2-nbsp-nbsp-实例"><a href="#2-nbsp-nbsp-实例" class="headerlink" title="2 &nbsp;&nbsp;实例"></a>2 &nbsp;&nbsp;实例</h2><p>本实例主要围绕 nginx 1.11 + php 7.1.3 + redis 3.1.1 + mysql 5.7 来讲解 docker 的操作过程。具体的知识也不会全面去讲解，仅仅是讲解需要用到的命令。更多的信息可以查阅官方文档。<br>后面我会以上面的 php 和 nginx 基础镜像为例来创建出我们生产环境下的 php 和 nginx，并推送到 hub.docker.com 上，这样其它服务器也可以拉取。</p>
<ol>
<li>php 很多扩展是没有安装的，所以还需在基础的镜像上创建出新的镜像。<br>需要的目录结构：</li>
</ol>
<ul>
<li>composer.phar php 依赖管理器</li>
<li>Dockerfile  需要编写的dockerfile文件</li>
<li>php-cp-1.5.0.tar.gz  数据库或者redis 连接池</li>
<li>php.ini  php配置文件</li>
<li>pool.ini  连接池配置文件</li>
<li>redis-3.1.1.tgz  php-redis扩展</li>
<li>startup 因为需要启动pool_server 和 php fpm，所以就用一个脚本来运行了。</li>
</ul>
<p>Dockerfile 内容如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM php:7.1.3-fpm-alpine</span><br><span class="line"></span><br><span class="line">COPY php.ini /usr/local/etc/php/php.ini</span><br><span class="line">COPY pool.ini /etc/pool.ini</span><br><span class="line">COPY redis-3.1.1.tgz /usr/local/src/redis-3.1.1.tgz</span><br><span class="line">COPY php-cp-1.5.0.tar.gz /usr/local/src/php-cp-1.5.0.tar.gz</span><br><span class="line">COPY composer.phar /usr/local/bin/composer</span><br><span class="line">COPY startup /run</span><br><span class="line">RUN docker-php-source extract \</span><br><span class="line">    &amp;&amp; cd /usr/local/src \</span><br><span class="line">    &amp;&amp; tar xzf redis-3.1.1.tgz \</span><br><span class="line">    &amp;&amp; tar xzf php-cp-1.5.0.tar.gz \</span><br><span class="line">    &amp;&amp; rm redis-3.1.1.tgz php-cp-1.5.0.tar.gz \</span><br><span class="line">    &amp;&amp; mv redis-3.1.1 /usr/src/php/ext/redis \</span><br><span class="line">    &amp;&amp; cp -r php-cp-1.5.0 /usr/src/php/ext/phpcp \</span><br><span class="line">    &amp;&amp; docker-php-ext-install redis \</span><br><span class="line">    &amp;&amp; docker-php-ext-install phpcp \</span><br><span class="line">    &amp;&amp; docker-php-source delete \</span><br><span class="line">    &amp;&amp; docker-php-ext-install pdo_mysql \</span><br><span class="line">    &amp;&amp; apk add --no-cache --virtual .build-deps libmcrypt-dev icu-dev libxslt-dev \</span><br><span class="line">    &amp;&amp; docker-php-ext-install -j$(getconf _NPROCESSORS_ONLN) iconv mcrypt zip mcrypt intl xsl \</span><br><span class="line">    &amp;&amp; apk add --no-cache freetype-dev libjpeg-turbo-dev libpng-dev \</span><br><span class="line">    &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \</span><br><span class="line">    &amp;&amp; docker-php-ext-install -j$(getconf _NPROCESSORS_ONLN) gd \</span><br><span class="line">    &amp;&amp; chmod +x /usr/local/bin/composer \</span><br><span class="line">    &amp;&amp; chmod +x /run/startup</span><br><span class="line"></span><br><span class="line">CMD [&quot;/run/startup&quot;]</span><br></pre></td></tr></table></figure></p>
<p>startup 内容如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">cd /usr/local/src/php-cp-1.5.0;</span><br><span class="line">php pool_server start</span><br><span class="line">php-fpm</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>nginx 安装 debug 调试扩展。<br>需要的目录结构：</li>
</ol>
<ul>
<li>Dockerfile  需要编写的dockerfile文件</li>
<li>nginx.conf  nginx 配置文件</li>
<li>nginx.vh.default.conf php  nginx 配置文件</li>
</ul>
<p>Dockerfile 内容如下：这部分我也没怎么改，就是加了 –with-debug \，COPY 的时候指向本地的文件<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM alpine:3.4</span><br><span class="line"></span><br><span class="line">MAINTAINER NGINX Docker Maintainers &quot;docker-maint@nginx.com&quot;</span><br><span class="line"></span><br><span class="line">ENV NGINX_VERSION 1.11.10</span><br><span class="line"></span><br><span class="line">RUN GPG_KEYS=B0F4253373F8F6F510D42178520A9993A1C052F8 \</span><br><span class="line">        &amp;&amp; CONFIG=&quot;\</span><br><span class="line">                --prefix=/etc/nginx \</span><br><span class="line">                --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                --modules-path=/usr/lib/nginx/modules \</span><br><span class="line">                --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">                --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">                --pid-path=/var/run/nginx.pid \</span><br><span class="line">                --lock-path=/var/run/nginx.lock \</span><br><span class="line">                --http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">                --http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">                --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">                --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">                --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">                --user=nginx \</span><br><span class="line">                --group=nginx \</span><br><span class="line">                --with-http_ssl_module \</span><br><span class="line">                --with-http_realip_module \</span><br><span class="line">                --with-http_addition_module \</span><br><span class="line">                --with-http_sub_module \</span><br><span class="line">                --with-http_dav_module \</span><br><span class="line">                --with-http_flv_module \</span><br><span class="line">                --with-http_mp4_module \</span><br><span class="line">                --with-http_gunzip_module \</span><br><span class="line">                --with-http_gzip_static_module \</span><br><span class="line">                --with-http_random_index_module \</span><br><span class="line">                --with-http_secure_link_module \</span><br><span class="line">                --with-http_stub_status_module \</span><br><span class="line">                --with-http_auth_request_module \</span><br><span class="line">                --with-http_xslt_module=dynamic \</span><br><span class="line">                --with-http_image_filter_module=dynamic \</span><br><span class="line">                --with-http_geoip_module=dynamic \</span><br><span class="line">                --with-http_perl_module=dynamic \</span><br><span class="line">                --with-threads \</span><br><span class="line">                --with-stream \</span><br><span class="line">                --with-stream_ssl_module \</span><br><span class="line">                --with-stream_ssl_preread_module \</span><br><span class="line">                --with-stream_realip_module \</span><br><span class="line">                --with-stream_geoip_module=dynamic \</span><br><span class="line">                --with-http_slice_module \</span><br><span class="line">                --with-mail \</span><br><span class="line">                --with-mail_ssl_module \</span><br><span class="line">                --with-compat \</span><br><span class="line">                --with-file-aio \</span><br><span class="line">                --with-http_v2_module \</span><br><span class="line">                --with-debug \</span><br><span class="line">        &quot; \</span><br><span class="line">        &amp;&amp; addgroup -S nginx \</span><br><span class="line">        &amp;&amp; adduser -D -S -h /var/cache/nginx -s /sbin/nologin -G nginx nginx \</span><br><span class="line">        &amp;&amp; apk add --no-cache --virtual .build-deps \</span><br><span class="line">                gcc \</span><br><span class="line">                libc-dev \</span><br><span class="line">                make \</span><br><span class="line">                openssl-dev \</span><br><span class="line">                pcre-dev \</span><br><span class="line">                zlib-dev \</span><br><span class="line">                linux-headers \</span><br><span class="line">                curl \</span><br><span class="line">                gnupg \</span><br><span class="line">                libxslt-dev \</span><br><span class="line">                gd-dev \</span><br><span class="line">                geoip-dev \</span><br><span class="line">                perl-dev \</span><br><span class="line">        &amp;&amp; curl -fSL http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz -o nginx.tar.gz \</span><br><span class="line">        &amp;&amp; curl -fSL http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz.asc  -o nginx.tar.gz.asc \</span><br><span class="line">        &amp;&amp; export GNUPGHOME=&quot;$(mktemp -d)&quot; \</span><br><span class="line">        &amp;&amp; gpg --keyserver ha.pool.sks-keyservers.net --recv-keys &quot;$GPG_KEYS&quot; \</span><br><span class="line">        &amp;&amp; gpg --batch --verify nginx.tar.gz.asc nginx.tar.gz \</span><br><span class="line">        &amp;&amp; rm -r &quot;$GNUPGHOME&quot; nginx.tar.gz.asc \</span><br><span class="line">        &amp;&amp; mkdir -p /usr/src \</span><br><span class="line">        &amp;&amp; tar -zxC /usr/src -f nginx.tar.gz \</span><br><span class="line">        &amp;&amp; rm nginx.tar.gz \</span><br><span class="line">        &amp;&amp; cd /usr/src/nginx-$NGINX_VERSION \</span><br><span class="line">        &amp;&amp; ./configure $CONFIG --with-debug \</span><br><span class="line">        &amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) \</span><br><span class="line">        &amp;&amp; mv objs/nginx objs/nginx-debug \</span><br><span class="line">        &amp;&amp; mv objs/ngx_http_xslt_filter_module.so objs/ngx_http_xslt_filter_module-debug.so \</span><br><span class="line">        &amp;&amp; mv objs/ngx_http_image_filter_module.so objs/ngx_http_image_filter_module-debug.so \</span><br><span class="line">        &amp;&amp; mv objs/ngx_http_geoip_module.so objs/ngx_http_geoip_module-debug.so \</span><br><span class="line">        &amp;&amp; mv objs/ngx_http_perl_module.so objs/ngx_http_perl_module-debug.so \</span><br><span class="line">        &amp;&amp; mv objs/ngx_stream_geoip_module.so objs/ngx_stream_geoip_module-debug.so \</span><br><span class="line">        &amp;&amp; ./configure $CONFIG \</span><br><span class="line">        &amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) \</span><br><span class="line">        &amp;&amp; make install \</span><br><span class="line">        &amp;&amp; rm -rf /etc/nginx/html/ \</span><br><span class="line">        &amp;&amp; mkdir /etc/nginx/conf.d/ \</span><br><span class="line">        &amp;&amp; mkdir -p /usr/share/nginx/html/ \</span><br><span class="line">        &amp;&amp; install -m644 html/index.html /usr/share/nginx/html/ \</span><br><span class="line">        &amp;&amp; install -m644 html/50x.html /usr/share/nginx/html/ \</span><br><span class="line">        &amp;&amp; install -m755 objs/nginx-debug /usr/sbin/nginx-debug \</span><br><span class="line">        &amp;&amp; install -m755 objs/ngx_http_xslt_filter_module-debug.so /usr/lib/nginx/modules/ngx_http_xslt_filter_module-debug.so \</span><br><span class="line">        &amp;&amp; install -m755 objs/ngx_http_image_filter_module-debug.so /usr/lib/nginx/modules/ngx_http_image_filter_module-debug.so \</span><br><span class="line">        &amp;&amp; install -m755 objs/ngx_http_geoip_module-debug.so /usr/lib/nginx/modules/ngx_http_geoip_module-debug.so \</span><br><span class="line">        &amp;&amp; install -m755 objs/ngx_http_perl_module-debug.so /usr/lib/nginx/modules/ngx_http_perl_module-debug.so \</span><br><span class="line">        &amp;&amp; install -m755 objs/ngx_stream_geoip_module-debug.so /usr/lib/nginx/modules/ngx_stream_geoip_module-debug.so \</span><br><span class="line">        &amp;&amp; ln -s ../../usr/lib/nginx/modules /etc/nginx/modules \</span><br><span class="line">        &amp;&amp; strip /usr/sbin/nginx* \</span><br><span class="line">        &amp;&amp; strip /usr/lib/nginx/modules/*.so \</span><br><span class="line">        &amp;&amp; rm -rf /usr/src/nginx-$NGINX_VERSION \</span><br><span class="line">        \</span><br><span class="line">        # Bring in gettext so we can get `envsubst`, then throw</span><br><span class="line">        # the rest away. To do this, we need to install `gettext`</span><br><span class="line">        # then move `envsubst` out of the way so `gettext` can</span><br><span class="line">        # be deleted completely, then move `envsubst` back.</span><br><span class="line">        &amp;&amp; apk add --no-cache --virtual .gettext gettext \</span><br><span class="line">        &amp;&amp; mv /usr/bin/envsubst /tmp/ \</span><br><span class="line">        \</span><br><span class="line">        &amp;&amp; runDeps=&quot;$( \</span><br><span class="line">                scanelf --needed --nobanner /usr/sbin/nginx /usr/lib/nginx/modules/*.so /tmp/envsubst \</span><br><span class="line">                        | awk &apos;&#123; gsub(/,/, &quot;\nso:&quot;, $2); print &quot;so:&quot; $2 &#125;&apos; \</span><br><span class="line">                        | sort -u \</span><br><span class="line">                        | xargs -r apk info --installed \</span><br><span class="line">                        | sort -u \</span><br><span class="line">        )&quot; \</span><br><span class="line">        &amp;&amp; apk add --no-cache --virtual .nginx-rundeps $runDeps \</span><br><span class="line">        &amp;&amp; apk del .build-deps \</span><br><span class="line">        &amp;&amp; apk del .gettext \</span><br><span class="line">        &amp;&amp; mv /tmp/envsubst /usr/local/bin/ \</span><br><span class="line">        \</span><br><span class="line">        # forward request and error logs to docker log collector</span><br><span class="line">        &amp;&amp; ln -sf /dev/stdout /var/log/nginx/access.log \</span><br><span class="line">        &amp;&amp; ln -sf /dev/stderr /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">COPY nginx.vh.default.conf /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 80 443</span><br><span class="line"></span><br><span class="line">CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>根据上面就可以构建出生产环境的 php 和 nginx 了。</p>
<ul>
<li>docker build -t wpxun/php:7.1.3 .</li>
<li>docker build -t wpxun/nginx:1.11 .</li>
</ul>
<p>然后push 到 hub.docker.com  </p>
<p><br><br><br></p>
<p> <strong>参考文献</strong><br>[1] Dockerfile 最佳实践. <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" target="_blank" rel="noopener">https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Docker/">Docker</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Docker/">Docker</a>, <a href="/tags/Dockerfile/">Dockerfile</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.jemper.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/DevOps/">DevOps</a><small>2</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>3</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>6</small></li>
  
    <li><a href="/categories/HTTPS/">HTTPS</a><small>5</small></li>
  
    <li><a href="/categories/日记/">日记</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/Docker/" style="font-size: 16.67px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/Golang/" style="font-size: 20px;">Golang</a> <a href="/tags/Go包/" style="font-size: 13.33px;">Go包</a> <a href="/tags/HTTP/" style="font-size: 16.67px;">HTTP</a> <a href="/tags/HTTP2/" style="font-size: 13.33px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 13.33px;">HTTPS</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Socket/" style="font-size: 13.33px;">Socket</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/TLS/" style="font-size: 16.67px;">TLS</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/io/" style="font-size: 13.33px;">io</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/协议/" style="font-size: 16.67px;">协议</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/工具/" style="font-size: 16.67px;">工具</a> <a href="/tags/并发/" style="font-size: 13.33px;">并发</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/架构/" style="font-size: 13.33px;">架构</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/编程/" style="font-size: 10px;">编程</a> <a href="/tags/网络/" style="font-size: 13.33px;">网络</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2019 Sven
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wpxun';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
