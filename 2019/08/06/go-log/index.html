<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>go log 包 | 在路上</title>
  <meta name="author" content="Sven">
  
  <meta name="description" content="让大家读得懂的知识才是真知识">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="go log 包"/>
  <meta property="og:site_name" content="在路上"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="在路上" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">在路上</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">关于我</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2019-08-06T08:44:00.000Z"><a href="/2019/08/06/go-log/">2019-08-06</a></time>
      
      
  
    <h1 class="title">go log 包</h1>
  

    </header>
    <div class="entry">
      
        
			<div id="toc" class="toc-article">
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-nbsp-nbsp-错误相关的概念"><span class="toc-text">1   错误相关的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-nbsp-nbsp-fmt-包"><span class="toc-text">2   fmt 包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-nbsp-nbsp-log-包"><span class="toc-text">3   log 包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-nbsp-nbsp-经验总结"><span class="toc-text">4   经验总结</span></a></li></ol>
			</div>
		
        <h2 id="1-nbsp-nbsp-错误相关的概念"><a href="#1-nbsp-nbsp-错误相关的概念" class="headerlink" title="1 &nbsp;&nbsp;错误相关的概念"></a>1 &nbsp;&nbsp;错误相关的概念</h2><ul>
<li><strong>编译错误</strong>：build的时候就报错，由于考虑不周或输入错误导致程序异常（Exception），比如数组越界访问，除数为零，堆栈溢出等等。是大意疏忽。</li>
<li><strong>运行错误</strong>：run的时候才报错，由于程序设计思路的错误导致程序异常或难以得到预期的效果。运行错误可以是预期的，也可以是不可预期的，对于可预期的不要用 panic，panic 恐慌机制是意料之外，如果不恢复（recover）就会导致宕机。<strong>宕机（panic）</strong>不是一件很好的事情，可能造成体验停止、服务中断，就像没有人希望在取钱时遇到 ATM 机蓝屏一样。但是，如果在损失发生时，程序没有因为宕机而停止，那么用户将会付出更大的代价，这种代价可以是金钱、时间甚至生命。因此宕机有时是一种合理的止损方法。</li>
<li><strong>error错误</strong>：错误是业务过程的一部分，而异常不是。错误是可预期的结果，error错误机制是意料之中。<a id="more"></a>
</li>
</ul>
<p>基于上面概念，我们可以把异常归为以下两种分类：</p>
<ul>
<li>Bug：不可预期，例如：不可预期的 panic，说不可预期本质上是粗心大意导致的</li>
<li>已知信息：可预期，error 错误（例如：网络连接断开、磁盘写入失败等）、可预期的 panic（recover 捕获变成 error，或者不捕获直接宕机）。在其它语言里，宕机往往以异常的形式存在。底层抛出异常，上层逻辑通过 try/catch 机制捕获异常，没有被捕获的严重异常会导致宕机，捕获的异常可以被忽略，上代码继续运行。<br>Go 没有异常系统，其使用 panic 触发宕机类似于其它语言的抛出异常，那么 recover 的宕机恢复机制就对应 try/catch 机制，能够通过 recover 捕获的原因在 panic() 函数前面已经运行过的 defer 语句依然会在宕机发生时发生作用，可以在 defer 内继续调用 panic，进一步将错误抛出。</li>
</ul>
<ol>
<li>错误转恐慌，比如程序逻辑上尝试请求某个 URL，最多尝试三次，尝试三次的过程中请求失败是错误，尝试完第三次还不成功的话，失败就被提升为恐慌宕机了。</li>
<li>恐慌转错误，比如 panic 触发的异常被 recover 恢复后，将返回值中 error 类型的变量进行赋值，以便上层函数继续走错误处理流程。</li>
</ol>
<p>基本上 goland 能提示的错误都是编译错误，此时如果进行编译，就会得到以下的错误信息<br># github.com/wpxun/client<br>.\main.go:45:20: cannot convert nima (type xx) to type string<br>在 Goland IDE 中一般会对输出做区分：一般 stdout 用黑色字体，stderr 用红色字体</p>
<h2 id="2-nbsp-nbsp-fmt-包"><a href="#2-nbsp-nbsp-fmt-包" class="headerlink" title="2 &nbsp;&nbsp;fmt 包"></a>2 &nbsp;&nbsp;fmt 包</h2><p>打印本质上就是把流写到 writer 对象上，并为了方便调用，提供了一系列函数。比如 Printf 并定制了 format 格式输出：</p>
<ul>
<li><p>%p 以地址的形式打印</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var a int = 123</span><br><span class="line">var b []int = []int&#123;1,2&#125;</span><br><span class="line">fmt.Printf(&quot;%p, %p&quot;, a, &amp;a) // 前者不是地址无效，后者是 a 变量的地址</span><br><span class="line">fmt.Printf(&quot;%p, %p&quot;, b, &amp;b) // 前者为 b 内容的地址，后者为 b 变量的地址</span><br></pre></td></tr></table></figure>
</li>
<li><p>%v、%#v，打印对象，%v 会去寻找 Stringer 接口，而 %#v 直接打印对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type myStruct struct&#123;</span><br><span class="line">	name1 int</span><br><span class="line">	name map[int]string</span><br><span class="line">&#125;</span><br><span class="line">func (myStruct) String () string &#123;</span><br><span class="line">	return &quot;Stringer echo&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//打印结构体</span><br><span class="line">var my myStruct = myStruct&#123;1, map[int]string&#123;1:&quot;123&quot;, 2:&quot;345&quot;&#125;&#125;</span><br><span class="line">fmt.Printf(&quot;%#v，%v&quot;, my, my)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-nbsp-nbsp-log-包"><a href="#3-nbsp-nbsp-log-包" class="headerlink" title="3 &nbsp;&nbsp;log 包"></a>3 &nbsp;&nbsp;log 包</h2><p>log.Logger 结构体核心属性是三个：文件描识符、前缀和标签。默认初始化<code>var std = New(os.Stderr, &quot;&quot;, LstdFlags)</code>，就是对三个属性的设置，可以看出默认是错误输出，并已经设置默认的 flags。包的使用方式主要有两种：</p>
<ul>
<li>使用默认的 std 变量，用于测试</li>
<li>使用自定义的 log.Logger 变量，调用 log.New 初始化，运用于产品</li>
</ul>
<p>log 公开的函数或 Logger 方法都是调用了 Logger.Output() 方法，有两个参数：</p>
<ul>
<li>calldepth：输出文件名的时候指向的函数栈的深度，仅在 Llongfile or Lshortfile 被设置时才起作用；0 层表示 Logger.Output() 处的 runtime.Caller(calldepth)，1 层表示调用Output那一行，也就是当前行，2 层表示再往上一层，也就是调用输出的函数栈；一般都设置为指向当前调用行或其上一个栈，所以层层调用要算好栈的深度。</li>
<li>字符串，可以使用 fmt.Sprintf 进行格式化后再输入</li>
</ul>
<h2 id="4-nbsp-nbsp-经验总结"><a href="#4-nbsp-nbsp-经验总结" class="headerlink" title="4 &nbsp;&nbsp;经验总结"></a>4 &nbsp;&nbsp;经验总结</h2><ul>
<li>调用方具有更多关于正在运行的程序的上下文，并且可以做出关于如何处理错误的更明智的决定（比如错误发生3次才做处理），<strong>所以谁调用，谁处理；这样的原则有很多，比如 molloc/free集中在同一个函数，谁发起 goroutine，谁就保证该 goroutine 不会泄漏，谁生成了 channel，谁就负责关闭 channel，channel 重复关闭会引发恐慌</strong>。</li>
<li>一般以模块为边界设计 Error，不同边界（或者不同层）采用 wrap 的方式嵌套，将异常进行传递，直到传递到调用方进行处理，这样的好处是各层的异常信息都传递了，并且每一层还可以附加最明了的错误信息，这有两个好处：<ul>
<li>明了的信息，这个明了的信息对用户友好，一般是“直接上层”传递过来的异常的友好说明，而不会再追究“上层以上的层”的错误信息</li>
<li>完整的错误链，因为嵌套的原因，所以可以把结构体输出却可</li>
</ul>
</li>
<li>设计要异常传递的信息，不要等到最后才去优化，就如同“超时取消”的设计一样，应该在最开始的阶段就设计好</li>
<li>设计需要的信息：区分项目、区分日志类型，日志格式，用标准的语言描述：<ul>
<li>发生了什么</li>
<li>发生在什么时间、什么位置</li>
<li>对用户友好的信息</li>
<li>告诉用户如何获得更多的信息</li>
</ul>
</li>
</ul>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Golang/">Golang</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Golang/">Golang</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.jemper.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>2</small></li>
  
    <li><a href="/categories/DevOps/">DevOps</a><small>3</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>4</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>8</small></li>
  
    <li><a href="/categories/HTTP/">HTTP</a><small>5</small></li>
  
    <li><a href="/categories/云原生/">云原生</a><small>8</small></li>
  
    <li><a href="/categories/日记/">日记</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 12px;">C</a> <a href="/tags/Docker/" style="font-size: 16px;">Docker</a> <a href="/tags/Golang/" style="font-size: 20px;">Golang</a> <a href="/tags/Go包/" style="font-size: 12px;">Go包</a> <a href="/tags/HTTP/" style="font-size: 14px;">HTTP</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 18px;">Kubernetes</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Service-Mesh/" style="font-size: 14px;">Service Mesh</a> <a href="/tags/Socket/" style="font-size: 12px;">Socket</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/TLS/" style="font-size: 14px;">TLS</a> <a href="/tags/io/" style="font-size: 12px;">io</a> <a href="/tags/协议/" style="font-size: 14px;">协议</a> <a href="/tags/容器/" style="font-size: 14px;">容器</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/工具/" style="font-size: 14px;">工具</a> <a href="/tags/并发/" style="font-size: 12px;">并发</a> <a href="/tags/架构/" style="font-size: 10px;">架构</a> <a href="/tags/编程/" style="font-size: 12px;">编程</a> <a href="/tags/网络/" style="font-size: 12px;">网络</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2019 Sven
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wpxun';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
