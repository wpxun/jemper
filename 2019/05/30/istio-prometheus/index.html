<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Istio Prometheus | 在路上</title>
  <meta name="author" content="Sven">
  
  <meta name="description" content="让大家读得懂的知识才是真知识">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Istio Prometheus"/>
  <meta property="og:site_name" content="在路上"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="在路上" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">在路上</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">关于我</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2019-05-29T16:33:00.000Z"><a href="/2019/05/30/istio-prometheus/">2019-05-30</a></time>
      
      
  
    <h1 class="title">Istio Prometheus</h1>
  

    </header>
    <div class="entry">
      
        
			<div id="toc" class="toc-article">
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-nbsp-nbsp-遥测插件的远程访问"><span class="toc-text">1   遥测插件的远程访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-nbsp-nbsp-istio"><span class="toc-text">1.1    istio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-nbsp-nbsp-port-forward-命令转发"><span class="toc-text">1.2    port-forward 命令转发</span></a></li></ol></li></ol>
			</div>
		
        <p>我选择 Istio 而非 Service Mesh 鼻祖 Linkerd 的原因，是 Istio 有大牌厂商支持、社区生态圈优势、重点支持 Kubernetes。<br><a id="more"></a></p>
<h2 id="1-nbsp-nbsp-遥测插件的远程访问"><a href="#1-nbsp-nbsp-遥测插件的远程访问" class="headerlink" title="1 &nbsp;&nbsp;遥测插件的远程访问"></a>1 &nbsp;&nbsp;遥测插件的远程访问</h2><p>这里有很多种方法：</p>
<ul>
<li>直接用 pod ip + pod port 去访问，</li>
<li>把 pod ip + pod port 映射到 istio 的 virtualservice</li>
<li>把 pod ip + pod port 映射到宿主机的端口</li>
</ul>
<p>比如这些 Pod 内部开放的端口：Prometheus：9090、Grafana：3000、Kiali：20001、Tracing：80，后两者我们演示一下。</p>
<h3 id="1-1-nbsp-nbsp-istio"><a href="#1-1-nbsp-nbsp-istio" class="headerlink" title="1.1 &nbsp;&nbsp; istio"></a>1.1 &nbsp;&nbsp; istio</h3><p>istio-ingressgateway 服务开放了 15020:31966/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32293/TCP,15030:30857/TCP,15031:30499/TCP,15032:31537/TCP,15443:32082/TCP 这些端口到宿主机，可以新建 istio 资源进行访问，官方有文档“<a href="https://istio.io/zh/docs/tasks/telemetry/gateways/" target="_blank" rel="noopener">遥测插件的远程访问</a>”</p>
<h3 id="1-2-nbsp-nbsp-port-forward-命令转发"><a href="#1-2-nbsp-nbsp-port-forward-命令转发" class="headerlink" title="1.2 &nbsp;&nbsp; port-forward 命令转发"></a>1.2 &nbsp;&nbsp; port-forward 命令转发</h3><p>比如 Prometheus：<br><code>kubectl -n istio-system port-forward  prometheus-d8d46c5b5-vb87x 9090:9090 &amp;</code><br><code>ssh -N -f -L 0.0.0.0:9091:127.0.0.1:9090 yhdodo19@0.0.0.0 -i ~/.ssh/googledodo</code><br><a href="http://35.237.188.250:9091" target="_blank" rel="noopener">http://35.237.188.250:9091</a></p>
<p>Grafana：<br><code>kubectl -n istio-system port-forward  grafana-67c69bb567-qfzm5 3000:3000 &amp;</code><br><code>ssh -N -f -L 0.0.0.0:9092:127.0.0.1:3000 yhdodo19@0.0.0.0 -i ~/.ssh/googledodo</code><br><a href="http://35.237.188.250:9092" target="_blank" rel="noopener">http://35.237.188.250:9092</a></p>
<p>kubectl -n istio-system port-forward istio-ingressgateway-5d8d989c76-cctpl 15000:15000 &amp;<br><code>ssh -N -f -L 0.0.0.0:9093:127.0.0.1:15000 yhdodo19@0.0.0.0 -i ~/.ssh/googledodo</code><br><a href="http://35.237.188.250:9093/listeners" target="_blank" rel="noopener">http://35.237.188.250:9093/listeners</a><br>查看该pod的监听器，默认只有 0.0.0.0:15090，比如我添加了 0.0.0.0:443，就可以接受 istio-ingressgateway svc 的 443 接口<br><a href="http://35.237.188.250:9093/config_dump" target="_blank" rel="noopener">http://35.237.188.250:9093/config_dump</a></p>
<p><code>ssh -N -f -L 0.0.0.0:80:127.0.0.1:31390 yhdodo19@0.0.0.0 -i ~/.ssh/googledodo</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;configs&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;@type&quot;:&quot;type.googleapis.com/envoy.admin.v2alpha.BootstrapConfigDump&quot;,</span><br><span class="line">            &quot;bootstrap&quot;:Object&#123;...&#125;,</span><br><span class="line">            &quot;last_updated&quot;:&quot;2019-06-25T10:15:56.689Z&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;@type&quot;:&quot;type.googleapis.com/envoy.admin.v2alpha.ClustersConfigDump&quot;,</span><br><span class="line">            &quot;version_info&quot;:&quot;2019-06-28T03:17:42Z/49&quot;,</span><br><span class="line">            &quot;static_clusters&quot;:Array[3],</span><br><span class="line">            &quot;dynamic_active_clusters&quot;:Array[100]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;@type&quot;:&quot;type.googleapis.com/envoy.admin.v2alpha.ListenersConfigDump&quot;,</span><br><span class="line">            &quot;version_info&quot;:&quot;2019-06-28T03:17:42Z/49&quot;,</span><br><span class="line">            &quot;static_listeners&quot;:Array[1],</span><br><span class="line">            &quot;dynamic_active_listeners&quot;:Array[1]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;@type&quot;:&quot;type.googleapis.com/envoy.admin.v2alpha.RoutesConfigDump&quot;,</span><br><span class="line">            &quot;static_route_configs&quot;:Array[1],</span><br><span class="line">            &quot;dynamic_route_configs&quot;:[</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;version_info&quot;:&quot;2019-06-28T03:17:42Z/49&quot;,</span><br><span class="line">                    &quot;route_config&quot;:&#123;</span><br><span class="line">                        &quot;name&quot;:&quot;http.443&quot;,</span><br><span class="line">                        &quot;virtual_hosts&quot;:[</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;name&quot;:&quot;kube.jemper.cn:443&quot;,</span><br><span class="line">                                &quot;domains&quot;:[</span><br><span class="line">                                    &quot;kube.jemper.cn&quot;,</span><br><span class="line">                                    &quot;kube.jemper.cn:443&quot;</span><br><span class="line">                                ],</span><br><span class="line">                                &quot;routes&quot;:[</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        &quot;match&quot;:&#123;</span><br><span class="line">                                            &quot;prefix&quot;:&quot;/sec&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;route&quot;:&#123;</span><br><span class="line">                                            &quot;cluster&quot;:&quot;outbound|82|v3|goapisec.default.svc.cluster.local&quot;,</span><br><span class="line">                                            &quot;timeout&quot;:&quot;0s&quot;,</span><br><span class="line">                                            &quot;retry_policy&quot;:&#123;</span><br><span class="line">                                                &quot;retry_on&quot;:&quot;connect-failure,refused-stream,unavailable,cancelled,resource-exhausted,retriable-status-codes&quot;,</span><br><span class="line">                                                &quot;num_retries&quot;:2,</span><br><span class="line">                                                &quot;retry_host_predicate&quot;:[</span><br><span class="line">                                                    &#123;</span><br><span class="line">                                                        &quot;name&quot;:&quot;envoy.retry_host_predicates.previous_hosts&quot;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                ],</span><br><span class="line">                                                &quot;host_selection_retry_max_attempts&quot;:&quot;5&quot;,</span><br><span class="line">                                                &quot;retriable_status_codes&quot;:[</span><br><span class="line">                                                    503</span><br><span class="line">                                                ]</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            &quot;max_grpc_timeout&quot;:&quot;0s&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;metadata&quot;:&#123;</span><br><span class="line">                                            &quot;filter_metadata&quot;:&#123;</span><br><span class="line">                                                &quot;istio&quot;:&#123;</span><br><span class="line">                                                    &quot;config&quot;:&quot;/apis/networking/v1alpha3/namespaces/default/virtual-service/goapi-default-xixi&quot;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;decorator&quot;:&#123;</span><br><span class="line">                                            &quot;operation&quot;:&quot;goapisec.default.svc.cluster.local:82/sec*&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;per_filter_config&quot;:&#123;</span><br><span class="line">                                            &quot;mixer&quot;:&#123;</span><br><span class="line">                                                &quot;disable_check_calls&quot;:true,</span><br><span class="line">                                                &quot;forward_attributes&quot;:&#123;</span><br><span class="line">                                                    &quot;attributes&quot;:&#123;</span><br><span class="line">                                                        &quot;destination.service.host&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapisec.default.svc.cluster.local&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.uid&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;istio://default/services/goapisec&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.name&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapisec&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.namespace&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;default&quot;</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;,</span><br><span class="line">                                                &quot;mixer_attributes&quot;:&#123;</span><br><span class="line">                                                    &quot;attributes&quot;:&#123;</span><br><span class="line">                                                        &quot;destination.service.host&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapisec.default.svc.cluster.local&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.uid&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;istio://default/services/goapisec&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.namespace&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;default&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.name&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapisec&quot;</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        &quot;match&quot;:&#123;</span><br><span class="line">                                            &quot;prefix&quot;:&quot;/&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;route&quot;:&#123;</span><br><span class="line">                                            &quot;cluster&quot;:&quot;outbound|81|v1|goapi.default.svc.cluster.local&quot;,</span><br><span class="line">                                            &quot;timeout&quot;:&quot;0s&quot;,</span><br><span class="line">                                            &quot;retry_policy&quot;:&#123;</span><br><span class="line">                                                &quot;retry_on&quot;:&quot;connect-failure,refused-stream,unavailable,cancelled,resource-exhausted,retriable-status-codes&quot;,</span><br><span class="line">                                                &quot;num_retries&quot;:2,</span><br><span class="line">                                                &quot;retry_host_predicate&quot;:[</span><br><span class="line">                                                    &#123;</span><br><span class="line">                                                        &quot;name&quot;:&quot;envoy.retry_host_predicates.previous_hosts&quot;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                ],</span><br><span class="line">                                                &quot;host_selection_retry_max_attempts&quot;:&quot;5&quot;,</span><br><span class="line">                                                &quot;retriable_status_codes&quot;:[</span><br><span class="line">                                                    503</span><br><span class="line">                                                ]</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            &quot;max_grpc_timeout&quot;:&quot;0s&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;metadata&quot;:&#123;</span><br><span class="line">                                            &quot;filter_metadata&quot;:&#123;</span><br><span class="line">                                                &quot;istio&quot;:&#123;</span><br><span class="line">                                                    &quot;config&quot;:&quot;/apis/networking/v1alpha3/namespaces/default/virtual-service/goapi-default-xixi&quot;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;decorator&quot;:&#123;</span><br><span class="line">                                            &quot;operation&quot;:&quot;goapi.default.svc.cluster.local:81/*&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;per_filter_config&quot;:&#123;</span><br><span class="line">                                            &quot;mixer&quot;:&#123;</span><br><span class="line">                                                &quot;disable_check_calls&quot;:true,</span><br><span class="line">                                                &quot;forward_attributes&quot;:&#123;</span><br><span class="line">                                                    &quot;attributes&quot;:&#123;</span><br><span class="line">                                                        &quot;destination.service.uid&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;istio://default/services/goapi&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.host&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapi.default.svc.cluster.local&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.namespace&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;default&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.name&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapi&quot;</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;,</span><br><span class="line">                                                &quot;mixer_attributes&quot;:&#123;</span><br><span class="line">                                                    &quot;attributes&quot;:&#123;</span><br><span class="line">                                                        &quot;destination.service.namespace&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;default&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.name&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapi&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.host&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;goapi.default.svc.cluster.local&quot;</span><br><span class="line">                                                        &#125;,</span><br><span class="line">                                                        &quot;destination.service.uid&quot;:&#123;</span><br><span class="line">                                                            &quot;string_value&quot;:&quot;istio://default/services/goapi&quot;</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        &quot;validate_clusters&quot;:false</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;last_updated&quot;:&quot;2019-06-28T03:17:42.772Z&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p> <strong>参考文献</strong><br>[1] 崔秀龙. 深入浅出 Istio | Service Mesh 快速入门与实践. 版次：2019年3月第1版<br>[2] 杨章显. Service Mesh 实战 | 基于 Linkerd 和 Kubernetes 的微服务实践. 版次：2019年1月第1版</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/云原生/">云原生</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Kubernetes/">Kubernetes</a>, <a href="/tags/Service-Mesh/">Service Mesh</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.jemper.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/DevOps/">DevOps</a><small>3</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>4</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>7</small></li>
  
    <li><a href="/categories/HTTP/">HTTP</a><small>5</small></li>
  
    <li><a href="/categories/云原生/">云原生</a><small>8</small></li>
  
    <li><a href="/categories/日记/">日记</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Docker/" style="font-size: 17.5px;">Docker</a> <a href="/tags/Golang/" style="font-size: 17.5px;">Golang</a> <a href="/tags/Go包/" style="font-size: 12.5px;">Go包</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Service-Mesh/" style="font-size: 15px;">Service Mesh</a> <a href="/tags/Socket/" style="font-size: 12.5px;">Socket</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/TLS/" style="font-size: 15px;">TLS</a> <a href="/tags/io/" style="font-size: 12.5px;">io</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/容器/" style="font-size: 15px;">容器</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/并发/" style="font-size: 12.5px;">并发</a> <a href="/tags/架构/" style="font-size: 10px;">架构</a> <a href="/tags/编程/" style="font-size: 10px;">编程</a> <a href="/tags/网络/" style="font-size: 12.5px;">网络</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2019 Sven
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wpxun';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
