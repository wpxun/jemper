<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>TCP/IP 原理 | 在路上的博客</title>
  <meta name="author" content="Sven">
  
  <meta name="description" content="让大家读得懂的知识才是真知识">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="TCP/IP 原理"/>
  <meta property="og:site_name" content="在路上的博客"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="在路上的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">在路上的博客</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">关于我</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2019-03-10T10:00:59.000Z"><a href="/2019/03/10/tcpip-theory/">2019-03-10</a></time>
      
      
  
    <h1 class="title">TCP/IP 原理</h1>
  

    </header>
    <div class="entry">
      
        <p>TCP 体系非常庞大，我对其理解只是冰山一角，此文只是将我学过的知识进行汇总。<br>学习的时候可以自己写服务端和客户端进行，抓包工具可以用 wireshark+npcap。<br><a id="more"></a></p>
<h2 id="1-nbsp-nbsp-状态转换"><a href="#1-nbsp-nbsp-状态转换" class="headerlink" title="1 &nbsp;&nbsp;状态转换"></a>1 &nbsp;&nbsp;状态转换</h2><h3 id="1-1-nbsp-nbsp-三次握手"><a href="#1-1-nbsp-nbsp-三次握手" class="headerlink" title="1.1 &nbsp;&nbsp;三次握手"></a>1.1 &nbsp;&nbsp;三次握手</h3><p><img src="http://img.jemper.cn/2019/03/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="TCP 三次握手"></p>
<h3 id="1-2-nbsp-nbsp-四次分手"><a href="#1-2-nbsp-nbsp-四次分手" class="headerlink" title="1.2 &nbsp;&nbsp;四次分手"></a>1.2 &nbsp;&nbsp;四次分手</h3><p><img src="http://img.jemper.cn/2019/03/%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B.png" alt="TCP 四次分手"><br>为什么上图中的A在TIME-WAIT状态必须等待2MSL时间呢？本质原因是 TCP 需要兼顾对服务端和客户端开启和结束地处理，换句话说就是不能只顾一方关闭而不管另一方是否关闭。<br>第一，为了保证A发送的最后一个ACK报文能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN+ACK报文段的确认。B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个重传的FIN+ACK报文段。如果A在TIME-WAIT状态不等待一段时间，而是在发送完ACK报文段后就立即释放连接，就无法收到B重传的FIN+ACK报文段，因而也不会再发送一次确认报文段。这样，B就无法按照正常的步骤进入CLOSED状态。<br>第二，A在发送完ACK报文段后，再经过2MSL时间，就可以使本连接持续的时间所产生的所有报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求的报文段。</p>
<h2 id="2-nbsp-nbsp-系统参数"><a href="#2-nbsp-nbsp-系统参数" class="headerlink" title="2 &nbsp;&nbsp;系统参数"></a>2 &nbsp;&nbsp;系统参数</h2><p>linux 和 unix 系统都是使用 sysctl -A 进行查看，有关 tcp 的配置可以使用命令 <code>sysctl -A | grep net.inet.tcp</code> 查看，以下例举一些常用的参数，后台的值是 macOS 系统的默认值。</p>
<ul>
<li><code>net.inet.tcp.msl</code>: 15000；此时 2msl = 30 秒。</li>
<li><code>net.inet.tcp.keepidle</code>: 7200000；</li>
<li><code>net.inet.tcp.keepintvl</code>: 75000；</li>
<li><code>net.inet.tcp.keepinit</code>: 75000；</li>
<li><code>net.inet.tcp.keepcnt</code>: 8；</li>
<li><code>net.inet.tcp.always_keepalive</code>: 0；</li>
</ul>
<h2 id="3-nbsp-nbsp-性能优化"><a href="#3-nbsp-nbsp-性能优化" class="headerlink" title="3 &nbsp;&nbsp;性能优化"></a>3 &nbsp;&nbsp;性能优化</h2><p>与 UDP 不同，TCP已经解决了分组丢失和重新排序的问题。套接字中的储存区和 seq 就可以解决该问题。</p>
<h3 id="3-1-nbsp-nbsp-滑动窗口"><a href="#3-1-nbsp-nbsp-滑动窗口" class="headerlink" title="3.1 &nbsp;&nbsp;滑动窗口"></a>3.1 &nbsp;&nbsp;滑动窗口</h3><p>滑动窗口是为解决服务端和客户端两边应用程序接收的速率不同导致带宽浪费的问题；我们知道，数据流进缓冲区，等待应用程序读取；对接收方，每次向发送发送 ACK 应答的时候就会告诉发送方当前己方的缓存剩余大小，如果发多了自己也接受不了；对发送方，如果接收方的窗口为 0 就只能等待，等待期间会不同发小的数据报看对方是否窗口 &gt; 0，以便继续发送数据。</p>
<h3 id="3-2-nbsp-nbsp-reset"><a href="#3-2-nbsp-nbsp-reset" class="headerlink" title="3.2 &nbsp;&nbsp;reset"></a>3.2 &nbsp;&nbsp;reset</h3><p>当TCP连接中途突然断掉，使用RST标志位指出连接被异常中止或拒绝连接请求，但是有一点例外，即客户机向服务机发送SYN时，因为服务机倾听套接字backlog已完成连接队列已满时，不会发送RST，有两个原因：<br>（1） 完成队列满的情况是暂时的，客户机应当继续发送几次SYN数据段；<br>（2） 即使发送了客户机也不知道具体是什么原因，只能认为服务机出异常而停止握手；</p>
<p>以下情况会发送RST：<br>（1） 客户端尝试与服务器未对外提供服务的端口建立TCP连接，服务器将会直接向客户端发送reset报文；<br>（2） 客户端和服务器的某一方在交互的过程中发生异常（如程序崩溃等），该方系统将向对端发送TCP reset报文，告之对方释放相关的TCP连接；<br>（3） 接收端收到TCP报文，但是发现该TCP的报文，并不在其已建立的TCP连接列表内，则其直接向对端发送reset报文；<br>（4） 在交互的双方中的某一方长期未收到来自对方的确认报文，则其在超出一定的重传次数或时间后，会主动向对端发送reset报文释放该TCP连接；<br>（5） 有些应用开发者在设计应用系统时，会利用reset报文快速释放已经完成数据交互的TCP连接，以提高业务交互的效率。</p>
<h3 id="3-3-nbsp-nbsp-超时与重传"><a href="#3-3-nbsp-nbsp-超时与重传" class="headerlink" title="3.3 &nbsp;&nbsp;超时与重传"></a>3.3 &nbsp;&nbsp;超时与重传</h3><h2 id="3-nbsp-nbsp-网络层优化"><a href="#3-nbsp-nbsp-网络层优化" class="headerlink" title="3 &nbsp;&nbsp;网络层优化"></a>3 &nbsp;&nbsp;网络层优化</h2>
      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/HTTPS/">HTTPS</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/TCP/">TCP</a>, <a href="/tags/IP/">IP</a>, <a href="/tags/性能/">性能</a>, <a href="/tags/协议/">协议</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.jemper.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/DevOps/">DevOps</a><small>2</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>1</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>6</small></li>
  
    <li><a href="/categories/HTTPS/">HTTPS</a><small>5</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Apline/" style="font-size: 10px;">Apline</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Go/" style="font-size: 20px;">Go</a> <a href="/tags/H2/" style="font-size: 13.33px;">H2</a> <a href="/tags/HTTP2/" style="font-size: 13.33px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 16.67px;">HTTPS</a> <a href="/tags/IP/" style="font-size: 10px;">IP</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Socket/" style="font-size: 13.33px;">Socket</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/TLS/" style="font-size: 16.67px;">TLS</a> <a href="/tags/context/" style="font-size: 10px;">context</a> <a href="/tags/dockerfile/" style="font-size: 10px;">dockerfile</a> <a href="/tags/io/" style="font-size: 10px;">io</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/time/" style="font-size: 10px;">time</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/协议/" style="font-size: 13.33px;">协议</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/工具/" style="font-size: 16.67px;">工具</a> <a href="/tags/并发/" style="font-size: 13.33px;">并发</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/性能/" style="font-size: 13.33px;">性能</a> <a href="/tags/架构/" style="font-size: 13.33px;">架构</a> <a href="/tags/编程/" style="font-size: 10px;">编程</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2019 Sven
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wpxun';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
